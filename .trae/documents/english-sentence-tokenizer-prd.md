# 英文句子分词与关联功能产品需求文档
(English Sentence Tokenizer & Word Association PRD)

## 1. 产品概述 (Product Overview)

### 1.1 背景 (Background)
当前系统已支持单词的增删改查及复习功能。为帮助用户在真实语境中记忆单词，需支持将完整英文句子或段落导入系统，自动分词后关联到已有单词或新建单词，实现句子-单词多对多映射，并保留全部标点符号。

### 1.2 目标 (Objectives)
1. 允许用户一次性粘贴整句/段落，系统自动按空格与标点分词，**保留所有标点符号**（逗号、句号、问号、感叹号、引号等）作为独立 token。
2. 提供可视化分词结果，支持拖拽调整 token 边界、合并/拆分、删除无关 token。
3. 为每个 token 自动匹配已有单词（不区分大小写），未命中时支持快捷新建或选择已有单词。
4. 保存后建立句子-单词多对多关联，支持双向查询：
   - 查看句子包含哪些单词。
   - 查看单词出现在哪些句子。
5. 前端组件与现有单词选择器/弹窗复用，后端事务保证句子与 token 一致性。

## 2. 需求详述 (Requirements)

### 2.1 功能需求 (Functional Requirements)
| 编号 | 描述 |
|----|------|
| FR1 | 用户进入“句子管理”页面，可见多行文本框与“分词”按钮。 |
| FR2 | 点击“分词”后，前端调用 POST /api/sentences/tokenize，传入原始文本，返回 token 数组，每个元素含 {position, text, type, matchedWord}。 |
| FR3 | 分词规则：以空格为界，连续标点作为一个 token；英文缩写（如 don't）视为一个 token。 |
| FR4 | 界面以卡片形式横向排列 token，支持拖拽调整顺序；点击 token 出现操作菜单：合并、拆分、删除、关联单词。 |
| FR5 | 对于 type=word 的 token，若 matchedWord 为空，提供“新建单词”或“选择已有”弹窗；已有选择器支持搜索与分页。 |
| FR6 | 用户点击“保存句子”后，前端提交 POST /api/sentences，payload 包含 {text, tokens: [{position, text, type, wordId}]}；后端在一个事务内插入 sentences、sentence_tokens，并返回 sentenceId。 |
| FR7 | 支持查看句子详情：GET /api/sentences/:id，返回句子文本与关联单词列表（含发音、释义）。 |
| FR8 | 支持查看单词关联句子：GET /api/words/:id/sentences，返回句子列表，可按创建时间倒序。 |
| FR9 | 句子列表页支持分页、搜索（按原文关键词）、删除句子（级联删除关联）。 |

### 2.2 非功能需求 (Non-Functional Requirements)
- 分词接口响应时间 < 200ms（1000 字符以内）。
- 支持至少 5000 字符段落一次性分词。
- 事务一致性：句子与 token 必须同时成功或回滚。
- 兼容现有权限体系：仅登录用户可管理句子。

## 3. 页面与流程 (Pages & Flow)

### 3.1 句子管理列表页 (/sentences)
- 顶部搜索框 + 新建句子按钮。
- 表格：原文（截断 120 字符）、关联单词数、创建时间、操作（查看、删除）。
- 分页：page/limit，默认 20 条。

### 3.2 新建/编辑句子页 (/sentences/new 或 /sentences/:id/edit)
- 多行文本框（默认 4 行，可展开）。
- 【分词】按钮：禁用状态直到文本非空。
- 分词结果区域：
  - 横向可拖拽列表，token 卡片显示原文，type=word 且已匹配时显示单词释义气泡。
  - 卡片颜色：word=蓝色，punctuation=灰色，未匹配单词=橙色。
  - 右键/点击出现菜单：合并(相邻)、拆分(仅单词)、删除、关联单词。
- 底部操作栏：保存（禁用直到所有 word token 已关联）、取消。

### 3.3 句子详情页 (/sentences/:id)
- 顶部原文（大字体）。
- 关联单词列表：卡片形式，点击跳转单词详情；支持移除单个关联。
- 底部：编辑、删除按钮。

## 4. 用户操作流程 (User Flow)
1. 用户粘贴 → 点击“分词” → 系统高亮展示 token → 用户调整/关联 → 保存 → 跳转详情页。
2. 在单词详情页可查看“例句”标签页，列出所有关联句子。

## 5. 边界与异常 (Edge Cases)
- 文本仅标点：允许保存，token 全部 type=punctuation，无单词关联。
- 重复句子文本：提示“已存在相同句子”，跳转已有句子详情。
- 删除单词时：级联删除该单词在所有句子中的关联，但不删除句子本身。
- 网络异常：前端显示友好提示，支持重试。

## 6. 验收标准 (Acceptance Criteria)
- AC1：输入含标点 200 字符段落，分词结果与人工计数一致，标点独立成 token。
- AC2：所有 word token 必须关联单词后才能保存，保存后数据库可见完整数据。
- AC3：单词详情页可查看例句列表，句子详情页可查看单词列表，双向数据一致。
- AC4：删除句子后，sentence_tokens 级联清空，单词不受影响。
- AC5：并发保存相同文本时，仅创建一条句子（唯一索引 on text(768)）。

---
*文档版本：v1.0*  
*作者：AI Assistant*  
*创建：2025-11-16*